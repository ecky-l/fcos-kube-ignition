---
variant: fcos
version: 1.0.0
storage:
  files:
    - path: /var/local/lib/dhcpd/dhcpd.conf
      mode: 0644
      overwrite: true
      contents:
        inline: |
          option domain-name     "${dhcpd.domain_name}";
          option domain-name-servers     ${dns};
          authoritative;
          default-lease-time 600;
          max-lease-time 7200;
          subnet ${dhcpd.net} netmask ${dhcpd.netmask} {
              range dynamic-bootp ${dhcpd.range_lower} ${dhcpd.range_upper};
              option broadcast-address ${dhcpd.broadcast};
              option routers ${dhcpd.ip};
              next-server ${dhcpd.ip};
              if exists user-class and option user-class = "iPXE" {
                  filename "http://${dhcpd.ip}:8080/boot.ipxe";
              } else {
                  filename "undionly.kpxe";
              }
          }
systemd:
  units:
    - name: dhcpd.service
      enabled: true
      contents: |
        [Unit]
        Description=dhcpd
        After=network-online.target
        Wants=network-online.target
        [Service]
        TimeoutStartSec=0
        ExecStartPre=-/bin/podman rm -f dhcpd
        ExecStartPre=/bin/podman pull networkboot/dhcpd
        ExecStart=/bin/podman run --name dhcpd --init --net host -v /var/local/lib/dhcpd:/data:Z networkboot/dhcpd ${dhcpd.interface}
        [Install]
        WantedBy=multi-user.target

