variant: fcos
version: 1.0.0
passwd:
  users:
    - name: core
      password_hash: "$${c}6$${c}mysecretsalt$${c}tD6lGf9FdSWKyrGT7O/h8DvbPso3lPDhYYxjmL.tInFSxnAAkjzRfMCew/.tVPkJMrSKhToVL2KUzKB9FMGWZ1"
      ssh_authorized_keys:
        - ${FCOS_SSH_PUBKEY}
storage:
  files:
    - path: /etc/modules-load.d/80-k8s.conf
      mode: 0644
      contents:
        inline: |
          br_netfilter
    - path: /etc/sysctl.d/80-k8s.conf
      mode: 0644
      contents:
        inline: |
          net.ipv4.ip_forward = 1
          net.bridge.bridge-nf-call-ip6tables = 1
          net.bridge.bridge-nf-call-iptables = 1
          vm.swappiness = 0
${FCOS_NETWORK_CONFIG}
    - path: /usr/local/bin/install-k8s.sh
      mode: 0755
      contents:
        inline: |
          #!/usr/bin/env bash
          # barely copied from https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/
          set -e
          echo "installing packages"
          command -v ethtool 2 >/dev/null || rpm-ostree install conntrack ethtool nmap-ncat --reboot

          echo "disabling selinux"
          setenforce 0
          sed -i 's/^SELINUX=enforcing$${c}/SELINUX=permissive/' /etc/selinux/config
          
          echo "installing cni plugins"
          mkdir -p /opt/cni/bin
          curl -fsL https://github.com/containernetworking/plugins/releases/download/v0.8.5/cni-plugins-linux-amd64-v0.8.5.tgz | tar -C /opt/cni/bin/ -xz
          echo "installing kubernetes ${FCOS_KUBE_VERSION}"
          for f in kubeadm kubelet kubectl; do
              curl -sfL --remote-name-all https://storage.googleapis.com/kubernetes-release/release/${FCOS_KUBE_VERSION}/bin/linux/amd64/$${c}f --output /usr/local/bin/$${c}f
              chmod 755 /usr/local/bin/$${c}f;
          done

          echo "Installing crictl ${FCOS_CRICTL_VERSION}"
          curl -sfL https://github.com/kubernetes-sigs/cri-tools/releases/download/${FCOS_CRICTL_VERSION}/crictl-${FCOS_CRICTL_VERSION}-linux-amd64.tar.gz | tar -C /usr/local/bin/ -xz

          for s in containerd kubelet; do
              systemctl enable $${c}s
              systemctl start $${c}s
          done
          sleep 5

          echo "Setting hostname to ${FCOS_HOSTNAME} (advertise ip = ${FCOS_ADVERTISE_IP})"
          hostnamectl set-hostname ${FCOS_HOSTNAME}
          echo "${FCOS_ADVERTISE_IP} ${FCOS_HOSTNAME}" >> /etc/hosts

          echo "Setting up kubernetes with ${FCOS_SETUP_COMMAND}"
          ${FCOS_SETUP_COMMAND} | tee /var/log/setup-k8s.log
          touch /var/log/k8s-installed
    - path: /etc/kubernetes/kubeadm-custom-config.yaml
      mode: 0644
      contents:
        inline: |
          ---
          apiVersion: kubeadm.k8s.io/v1beta2
          kind: InitConfiguration
          bootstrapTokens:
            - groups:
                - system:bootstrappers:kubeadm:default-node-token
              token: m41n6u.ix7tfu70yj9h94iw
              ttl: 24h0m0s
              usages:
                - signing
                - authentication
          localAPIEndpoint:
            advertiseAddress: ${FCOS_ADVERTISE_IP}
            bindPort: 6443
          nodeRegistration:
            criSocket: /run/containerd/containerd.sock
            name: ${FCOS_HOSTNAME}
            taints:
              - effect: NoSchedule
                key: node-role.kubernetes.io/master
          ---
          apiVersion: kubeadm.k8s.io/v1beta2
          kind: ClusterConfiguration
          kubernetesVersion: ${FCOS_KUBE_VERSION}
          apiServer:
            extraArgs:
              advertise-address: ${FCOS_ADVERTISE_IP}
            timeoutForControlPlane: 4m0s
          certificatesDir: /etc/kubernetes/pki
          clusterName: kubernetes
          controllerManager:
            extraArgs:
              flex-volume-plugin-dir: /var/lib/kubelet/kubelet-plugins/volume/exec
          dns:
            type: CoreDNS
          etcd:
            local:
              dataDir: /var/lib/etcd
          imageRepository: k8s.gcr.io
          networking:
            dnsDomain: cluster.local
            podSubnet: 10.244.0.0/16
            serviceSubnet: 10.96.0.0/12
          scheduler: {}
          ...
systemd:
  units:
    - name: docker.service
      mask: true
    - name: kubelet.service
      enabled: false
      contents: |
        [Unit]
        Description=kubelet: The Kubernetes Node Agent
        Documentation=https://kubernetes.io/docs/home/
        [Service]
        ExecStart=/usr/local/bin/kubelet
        Restart=always
        StartLimitInterval=0
        RestartSec=10
        [Install]
        WantedBy=multi-user.target
      dropins:
        - name: 10-kubeadm.conf
          contents: |
            # Note: This dropin only works with kubeadm and kubelet v1.11+
            [Service]
            Environment="KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf"
            Environment="KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml"
            # This is a file that "kubeadm init" and "kubeadm join" generates at runtime, populating the KUBELET_KUBEADM_ARGS variable dynamically
            EnvironmentFile=-/var/lib/kubelet/kubeadm-flags.env
            # This is a file that the user can use for overrides of the kubelet args as a last resort. Preferably, the user should use
            # the .NodeRegistration.KubeletExtraArgs object in the configuration files instead. KUBELET_EXTRA_ARGS should be sourced from this file.
            EnvironmentFile=-/etc/sysconfig/kubelet
            ExecStart=
            ExecStart=/usr/local/bin/kubelet $${c}KUBELET_KUBECONFIG_ARGS $${c}KUBELET_CONFIG_ARGS $${c}KUBELET_KUBEADM_ARGS $${c}KUBELET_EXTRA_ARGS
    - name: install-k8s.service
      enabled: true
      contents: |
        [Unit]
        Description=Install Kubernetes
        After=network-online.target
        Wants=network-online.target
        Before=systemd-user-sessions.service
        ConditionPathExists=!/var/log/k8s-installed
        [Service]
        Type=oneshot
        RemainAfterExit=true
        ExecStart=/bin/bash /usr/local/bin/install-k8s.sh
        StandardOutput=syslog+kmsg+console
        StandardError=syslog+kmsg+console
        [Install]
        WantedBy=multi-user.target

